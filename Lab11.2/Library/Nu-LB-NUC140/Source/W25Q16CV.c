#include "stdio.h"
#include "string.h"
#include "NUC100Series.h"
#include "SYS.h"
#include "SPI.h"
#include "W25Q16CV.h"

void init_W25Q16(void)
{
	SPI_Open(W25Q16_SPI_PORT, SPI_MASTER, SPI_MODE_0, 8, 500000);
	SPI_DisableAutoSS(W25Q16_SPI_PORT);
	SPI_SET_MSB_FIRST(W25Q16_SPI_PORT);
}

// Command
void W25Q16_Command(uint8_t command)
{
  SPI_SET_SS0_LOW(W25Q16_SPI_PORT);
	
  SPI_WRITE_TX0(W25Q16_SPI_PORT, command); 
  SPI_TRIGGER(W25Q16_SPI_PORT);                    
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));  
	
  SPI_SET_SS0_HIGH(W25Q16_SPI_PORT);	
}

// Write Enable
void W25Q16_WriteEnable(void)
{
  W25Q16_Command(W25Q16_WRITE_ENABLE); 	
}

// Write Enable for Volatile Status Register
void W25Q16_WriteEnableForVolatileStatusRegister(void)
{
  W25Q16_Command(W25Q16_WRITE_ENABLE_FOR_VOLATILE_STATUS_REGISTER );  
}

// Write Disable
void W25Q16_WriteDisable(void)
{
  W25Q16_Command(W25Q16_WRITE_DISABLE ); 
}

// Read Status Register 1
uint8_t W25Q16_ReadStatusRegister1(void)
{
	uint32_t tmp;
  SPI_SET_SS0_LOW(W25Q16_SPI_PORT);
	
  SPI_WRITE_TX0(W25Q16_SPI_PORT, W25Q16_READ_STATUS_REGISTER1 ); 
  SPI_TRIGGER(W25Q16_SPI_PORT);                    
  while(SPI_IS_BUSY(W25Q16_SPI_PORT)); 
	
  SPI_WRITE_TX0(W25Q16_SPI_PORT, 0xff);	
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));	
  tmp =W25Q16_SPI_PORT->RX[0];
	
  SPI_SET_SS0_HIGH(W25Q16_SPI_PORT);
	return tmp;
}	

// Read Status Register 2
uint8_t W25Q16_ReadStatusRegister2(void)
{
	uint32_t tmp;
  SPI_SET_SS0_LOW(W25Q16_SPI_PORT);
	
  SPI_WRITE_TX0(W25Q16_SPI_PORT, W25Q16_READ_STATUS_REGISTER2 ); 
  SPI_TRIGGER(W25Q16_SPI_PORT);                    
  while(SPI_IS_BUSY(W25Q16_SPI_PORT)); 
	
  SPI_WRITE_TX0(W25Q16_SPI_PORT, 0xff);	
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));	
  tmp = W25Q16_SPI_PORT->RX[0];
	
  SPI_SET_SS0_HIGH(W25Q16_SPI_PORT);
	return tmp;
}	

// Write Status Register
void W25Q16_WriteStatusRegister(uint16_t u16data)
{
  SPI_SET_SS0_LOW(W25Q16_SPI_PORT);
	
  SPI_WRITE_TX0(W25Q16_SPI_PORT, W25Q16_WRITE_STATUS_REGISTER ); 
  SPI_TRIGGER(W25Q16_SPI_PORT);                    
  while(SPI_IS_BUSY(W25Q16_SPI_PORT)); 
	
  SPI_WRITE_TX0(W25Q16_SPI_PORT, u16data &0x00FF);	
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));	
  SPI_WRITE_TX0(W25Q16_SPI_PORT, u16data>>8);	
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));

  SPI_SET_SS0_HIGH(W25Q16_SPI_PORT);	
}

// Page Program
void W25Q16_PageProgram(uint32_t u24addr, uint8_t *data)
{
	uint32_t i;
  SPI_SET_SS0_LOW(W25Q16_SPI_PORT);
	
  SPI_WRITE_TX0(W25Q16_SPI_PORT, W25Q16_PAGE_PROGRAM ); 
  SPI_TRIGGER(W25Q16_SPI_PORT);                    
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));  
	
  SPI_WRITE_TX0(W25Q16_SPI_PORT, (u24addr>>16)&0x000000FF);
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));
  SPI_WRITE_TX0(W25Q16_SPI_PORT, (u24addr>>8)&0x000000FF);
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));
  SPI_WRITE_TX0(W25Q16_SPI_PORT, u24addr&0x000000FF);
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));
	
	for (i=0; i<strlen(data); i++) {
      SPI_WRITE_TX0(W25Q16_SPI_PORT, data[i]);
      SPI_TRIGGER(W25Q16_SPI_PORT);
      while(SPI_IS_BUSY(W25Q16_SPI_PORT));
	}
	
  SPI_SET_SS0_HIGH(W25Q16_SPI_PORT);	
}

// Sector Erase
void W25Q16_SectorErase(uint32_t u24addr)
{
  SPI_SET_SS0_LOW(W25Q16_SPI_PORT);
	
  SPI_WRITE_TX0(W25Q16_SPI_PORT, W25Q16_SECTOR_ERASE ); 
  SPI_TRIGGER(W25Q16_SPI_PORT);                    
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));  
	
  SPI_WRITE_TX0(W25Q16_SPI_PORT, (u24addr>>16)&0x000000FF);
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));
  SPI_WRITE_TX0(W25Q16_SPI_PORT, (u24addr>>8)&0x000000FF);
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));
  SPI_WRITE_TX0(W25Q16_SPI_PORT, u24addr&0x000000FF);
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));
	
  SPI_SET_SS0_HIGH(W25Q16_SPI_PORT);	
}

// Block Erase 32KB
void W25Q16_BlockErase32KB(uint32_t u24addr)
{
  SPI_SET_SS0_LOW(W25Q16_SPI_PORT);
	
  SPI_WRITE_TX0(W25Q16_SPI_PORT, W25Q16_BLOCK_ERASE_32KB ); 
  SPI_TRIGGER(W25Q16_SPI_PORT);                    
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));  
	
  SPI_WRITE_TX0(W25Q16_SPI_PORT, (u24addr>>16)&0x000000FF);
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));
  SPI_WRITE_TX0(W25Q16_SPI_PORT, (u24addr>>8)&0x000000FF);
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));
  SPI_WRITE_TX0(W25Q16_SPI_PORT, u24addr&0x000000FF);
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));
	
  SPI_SET_SS0_HIGH(W25Q16_SPI_PORT);	
}


// Block Erase 64KB
void W25Q16_BlockErase64KB(uint32_t u24addr)
{
  SPI_SET_SS0_LOW(W25Q16_SPI_PORT);
	
  SPI_WRITE_TX0(W25Q16_SPI_PORT, W25Q16_BLOCK_ERASE_64KB ); 
  SPI_TRIGGER(W25Q16_SPI_PORT);                    
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));  
	
  SPI_WRITE_TX0(W25Q16_SPI_PORT, (u24addr>>16)&0x000000FF);
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));
  SPI_WRITE_TX0(W25Q16_SPI_PORT, (u24addr>>8)&0x000000FF);
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));
  SPI_WRITE_TX0(W25Q16_SPI_PORT, u24addr&0x000000FF);
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));
	
  SPI_SET_SS0_HIGH(W25Q16_SPI_PORT);	
}

// Chip Erase
void W25Q16_ChipErase(void)
{
  W25Q16_Command(W25Q16_CHIP_ERASE); 
}

// Erase Suspend
void W25Q16_EraseSuspend(void)
{
  W25Q16_Command(W25Q16_ERASE_SUSPEND); 
}

// Erase Resume
void W25Q16_EraseResume(void)
{
  W25Q16_Command(W25Q16_ERASE_RESUME); 	
}

// Erase Resume
void W25Q16_PowerDown(void)
{
  W25Q16_Command(W25Q16_POWER_DOWN); 
}

// Continuouse Read Mode Reset
void W25Q16_ContinuouseReadModeReset(void)
{
  SPI_SET_SS0_LOW(W25Q16_SPI_PORT);
	
  SPI_WRITE_TX0(W25Q16_SPI_PORT, W25Q16_CONTINUOUS_READ_MODE_RESET); 
  SPI_TRIGGER(W25Q16_SPI_PORT);                    
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));  
	
  SPI_WRITE_TX0(W25Q16_SPI_PORT, 0xff);
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));
	
  SPI_SET_SS0_HIGH(W25Q16_SPI_PORT);	
}

// Read Data
uint8_t W25Q16_ReadData(uint32_t u24addr)
{
	uint32_t tmp;
  SPI_SET_SS0_LOW(W25Q16_SPI_PORT);
	
  SPI_WRITE_TX0(W25Q16_SPI_PORT, W25Q16_READ_DATA ); 
  SPI_TRIGGER(W25Q16_SPI_PORT);                    
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));  
	
  SPI_WRITE_TX0(W25Q16_SPI_PORT, (u24addr>>16)&0x000000FF);
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));
  SPI_WRITE_TX0(W25Q16_SPI_PORT, (u24addr>>8)&0x000000FF);
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));
  SPI_WRITE_TX0(W25Q16_SPI_PORT, u24addr&0x000000FF);
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));
	
  SPI_WRITE_TX0(W25Q16_SPI_PORT, 0xff);	
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));	
  tmp = W25Q16_SPI_PORT->RX[0];
	
  SPI_SET_SS0_HIGH(W25Q16_SPI_PORT);	
	return tmp;
}

// Release Power Down / Device ID
uint8_t W25Q16_ReleasePowerDown_DeviceID(void)
{
	uint32_t tmp;
  SPI_SET_SS0_LOW(W25Q16_SPI_PORT);
	
  SPI_WRITE_TX0(W25Q16_SPI_PORT, W25Q16_RELEASE_PWRDN_DEVICE_ID ); 
  SPI_TRIGGER(W25Q16_SPI_PORT);                    
  while(SPI_IS_BUSY(W25Q16_SPI_PORT)); 
	
  SPI_WRITE_TX0(W25Q16_SPI_PORT, 0xff);	
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));	

  SPI_WRITE_TX0(W25Q16_SPI_PORT, 0xff);	
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));	

  SPI_WRITE_TX0(W25Q16_SPI_PORT, 0xff);	
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));	

  SPI_WRITE_TX0(W25Q16_SPI_PORT, 0xff);	
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));	
  tmp = W25Q16_SPI_PORT->RX[0];
	
  SPI_SET_SS0_HIGH(W25Q16_SPI_PORT);
	return tmp;
}	

// Read Manufacturer & Device ID
uint16_t W25Q16_ReadManufacturerDeviceID(void)
{
	uint32_t mf, id;
  SPI_SET_SS0_LOW(W25Q16_SPI_PORT);
	
  SPI_WRITE_TX0(W25Q16_SPI_PORT, W25Q16_MANUFACTURER_DEVICE_ID ); 
  SPI_TRIGGER(W25Q16_SPI_PORT);                    
  while(SPI_IS_BUSY(W25Q16_SPI_PORT)); 
	
  SPI_WRITE_TX0(W25Q16_SPI_PORT, 0xff);	
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));	

  SPI_WRITE_TX0(W25Q16_SPI_PORT, 0xff);	
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));	

  SPI_WRITE_TX0(W25Q16_SPI_PORT, 0x00);	
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));	

  SPI_WRITE_TX0(W25Q16_SPI_PORT, 0xff);	
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));	
  mf = W25Q16_SPI_PORT->RX[0];

  SPI_WRITE_TX0(W25Q16_SPI_PORT, 0xff);	
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));	
  id = W25Q16_SPI_PORT->RX[0];
	
  SPI_SET_SS0_HIGH(W25Q16_SPI_PORT);
	return ((mf<<8)&0x0000FF00) | (id&0x00000000FF);
}	

// Read JEDEC ID
uint32_t W25Q16_ReadJEDECID(void)
{
	uint32_t mf, tmp[2];
  SPI_SET_SS0_LOW(W25Q16_SPI_PORT);
	
  SPI_WRITE_TX0(W25Q16_SPI_PORT, W25Q16_READ_JEDEC_ID ); 
  SPI_TRIGGER(W25Q16_SPI_PORT);                    
  while(SPI_IS_BUSY(W25Q16_SPI_PORT)); 

  SPI_WRITE_TX0(W25Q16_SPI_PORT, 0xff);	
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));	
  mf = W25Q16_SPI_PORT->RX[0];

  SPI_WRITE_TX0(W25Q16_SPI_PORT, 0xff);	
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));	
  tmp[1] = W25Q16_SPI_PORT->RX[0];

  SPI_WRITE_TX0(W25Q16_SPI_PORT, 0xff);	
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));	
  tmp[0] = W25Q16_SPI_PORT->RX[0];
	
  SPI_SET_SS0_HIGH(W25Q16_SPI_PORT);
	return ((mf<<16)&0x00FF0000) | ((tmp[1]<<8) & 0x0000FF00) | (tmp[0] & 0x000000FF);
}	

// Read Unique ID
uint8_t W25Q16_ReadUniqueID(void)
{
	uint32_t id;
  SPI_SET_SS0_LOW(W25Q16_SPI_PORT);
	
  SPI_WRITE_TX0(W25Q16_SPI_PORT, W25Q16_READ_UNIQUE_ID ); 
  SPI_TRIGGER(W25Q16_SPI_PORT);                    
  while(SPI_IS_BUSY(W25Q16_SPI_PORT)); 

  SPI_WRITE_TX0(W25Q16_SPI_PORT, 0xff);	
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));	

  SPI_WRITE_TX0(W25Q16_SPI_PORT, 0xff);	
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));	

	SPI_WRITE_TX0(W25Q16_SPI_PORT, 0xff);	
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));

	SPI_WRITE_TX0(W25Q16_SPI_PORT, 0xff);	
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));
	
  SPI_WRITE_TX0(W25Q16_SPI_PORT, 0xff);	
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));	
  id = W25Q16_SPI_PORT->RX[0];
	
  SPI_SET_SS0_HIGH(W25Q16_SPI_PORT);
	return id;
}	

// Read SFDP Register
uint8_t W25Q16_ReadSFDPRegister(uint8_t addr)
{
	uint32_t data;
  SPI_SET_SS0_LOW(W25Q16_SPI_PORT);
	
  SPI_WRITE_TX0(W25Q16_SPI_PORT, W25Q16_READ_SFDP_REGISTER ); 
  SPI_TRIGGER(W25Q16_SPI_PORT);                    
  while(SPI_IS_BUSY(W25Q16_SPI_PORT)); 

  SPI_WRITE_TX0(W25Q16_SPI_PORT, 0x00);	
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));	

  SPI_WRITE_TX0(W25Q16_SPI_PORT, 0x00);	
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));	

	SPI_WRITE_TX0(W25Q16_SPI_PORT, addr);	
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));

	SPI_WRITE_TX0(W25Q16_SPI_PORT, 0xff);	
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));
	
  SPI_WRITE_TX0(W25Q16_SPI_PORT, 0xff);	
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));	
  data = W25Q16_SPI_PORT->RX[0];
	
  SPI_SET_SS0_HIGH(W25Q16_SPI_PORT);
	return data;
}

// Erase Security Registers
void W25Q16_EraseSecurityRegisters(uint32_t u24addr)
{
  SPI_SET_SS0_LOW(W25Q16_SPI_PORT);
	
  SPI_WRITE_TX0(W25Q16_SPI_PORT, W25Q16_ERASE_SECURITY_REGISTERS ); 
  SPI_TRIGGER(W25Q16_SPI_PORT);                    
  while(SPI_IS_BUSY(W25Q16_SPI_PORT)); 

  SPI_WRITE_TX0(W25Q16_SPI_PORT, (u24addr>>16)&0x000000FF);
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));
  SPI_WRITE_TX0(W25Q16_SPI_PORT, (u24addr>>8)&0x000000FF);
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));
  SPI_WRITE_TX0(W25Q16_SPI_PORT, u24addr&0x000000FF);
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));
	
  SPI_SET_SS0_HIGH(W25Q16_SPI_PORT);
}


// Erase Security Registers
void W25Q16_ProgramSecurityRegiters(uint32_t u24addr, uint8_t data)
{
  SPI_SET_SS0_LOW(W25Q16_SPI_PORT);
	
  SPI_WRITE_TX0(W25Q16_SPI_PORT, W25Q16_PROGRAM_SECURITY_REGISTERS ); 
  SPI_TRIGGER(W25Q16_SPI_PORT);                    
  while(SPI_IS_BUSY(W25Q16_SPI_PORT)); 

  SPI_WRITE_TX0(W25Q16_SPI_PORT, (u24addr>>16)&0x000000FF);
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));
  SPI_WRITE_TX0(W25Q16_SPI_PORT, (u24addr>>8)&0x000000FF);
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));
  SPI_WRITE_TX0(W25Q16_SPI_PORT, u24addr&0x000000FF);
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));
	
	SPI_WRITE_TX0(W25Q16_SPI_PORT, data);	
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));
	
	SPI_WRITE_TX0(W25Q16_SPI_PORT, data);	
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));	
	
  SPI_SET_SS0_HIGH(W25Q16_SPI_PORT);
}

uint8_t W25Q16_ReadSecurityRegisters(uint32_t u24addr)
{
	uint32_t data;
  SPI_SET_SS0_LOW(W25Q16_SPI_PORT);
	
  SPI_WRITE_TX0(W25Q16_SPI_PORT, W25Q16_READ_SECURITY_REGISTERS ); 
  SPI_TRIGGER(W25Q16_SPI_PORT);                    
  while(SPI_IS_BUSY(W25Q16_SPI_PORT)); 

  SPI_WRITE_TX0(W25Q16_SPI_PORT, (u24addr>>16)&0x000000FF);
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));
  SPI_WRITE_TX0(W25Q16_SPI_PORT, (u24addr>>8)&0x000000FF);
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));
  SPI_WRITE_TX0(W25Q16_SPI_PORT, u24addr&0x000000FF);
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));
	
	SPI_WRITE_TX0(W25Q16_SPI_PORT, 0xff);	
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));
	
  SPI_WRITE_TX0(W25Q16_SPI_PORT, 0xff);	
  SPI_TRIGGER(W25Q16_SPI_PORT);
  while(SPI_IS_BUSY(W25Q16_SPI_PORT));	
  data = W25Q16_SPI_PORT->RX[0] & 0x000000FF;
	
  SPI_SET_SS0_HIGH(W25Q16_SPI_PORT);
	return data;
}
